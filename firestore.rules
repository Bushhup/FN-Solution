/**
 * Core Philosophy:
 * This ruleset implements a Role-Based Access Control (RBAC) model combined with
 * user ownership. It defines two primary roles: 'Admin' and 'User', stored in
 * each user's profile document. The Admin role grants broad read and write
 * permissions, while standard users have strict ownership over their own data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, including the critical `role` field.
 * - /services/{serviceId}: Public catalog of services.
 * - /leads/{leadId}: Collection of user-submitted inquiries.
 * - /testimonials/{testimonialId}: Public collection of reviews.
 *
 * Key Security Decisions:
 * - Admin status is determined by checking the `role` field in the user's
 *   document: `get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin'`.
 *   This is a scalable and manageable approach for multi-admin systems.
 * - Listing all users is restricted to admins to protect privacy.
 * - Public data (services, testimonials) is structurally segregated for safe listing.
 * - Leads can be created by anyone, but viewing is restricted to the owner or an admin.
 *
 * Denormalization for Authorization:
 * - leads.userId: Each lead document submitted by an authenticated user contains
 *   a denormalized 'userId' field. This allows a user to query for their own
 *   leads and for security rules to verify ownership without extra database reads.
 *
 * Structural Segregation:
 * Public and private data are stored in separate top-level collections. For
 * example, /services and /testimonials are fully public for reads, while /users
 * is strictly private on a per-user basis (except for admins).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the current user has administrative privileges by reading their
     * role from their user profile document.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    /**
     * Ensures that the document being modified already exists.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Validates that the user ID in a new user document matches the document's ID.
     */
    function isConsistentUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Enforces immutability of the user ID field on update.
     */
    function isUserIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates a new lead document for relational integrity.
     */
    function isLeadDataValidOnCreate() {
      let isAuthUserLead = isSignedIn() && request.resource.data.userId == request.auth.uid;
      let isGuestLead = !isSignedIn() && !('userId' in request.resource.data);
      return isAuthUserLead || isGuestLead;
    }

    /**
     * Enforces immutability of the lead's owner (`userId`) on update.
     */
    function isLeadOwnerImmutable() {
      return ('userId' in resource.data)
        ? request.resource.data.userId == resource.data.userId
        : !('userId' in request.resource.data);
    }
    
    /**
    * Allows an admin to change any field except for the user's ID.
    * A regular user can only change their own profile fields, but cannot change their own role.
    */
    function canUpdateUser(userId) {
      // An owner can't normally change their role. This is the check for a valid owner update.
      let isOwnerUpdate = isOwner(userId) && (
        request.resource.data.role == resource.data.role ||
        // Exception: allow frank@gmail.com to set their role to Admin to seed the first admin.
        (request.auth.token.email == 'frank@gmail.com' && request.resource.data.role == 'Admin')
      );
      
      return (isAdmin() || isOwnerUpdate) && isExistingDoc() && isUserIdImmutable();
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Stores user profiles. The `role` field determines admin access.
     * @path /users/{userId}
     * @allow (get) An authenticated user reading their own profile, or an admin reading any profile.
     * @allow (list) An admin listing all users.
     * @allow (create) An authenticated user creating their own profile.
     * @allow (update) An admin can update any profile. A user can update their own profile but cannot change their role.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && isConsistentUserDataOnCreate(userId);
      allow update: if canUpdateUser(userId);
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Catalog of available services. Publicly readable, admin writable.
     * @path /services/{serviceId}
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Service inquiries. Creatable by anyone, readable by owner or admin.
     * @path /leads/{leadId}
     */
    match /leads/{leadId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if isLeadDataValidOnCreate();
      allow update: if isExistingDoc() && (isOwner(resource.data.userId) || isAdmin()) && isLeadOwnerImmutable();
      allow delete: if isExistingDoc() && (isOwner(resource.data.userId) || isAdmin());
    }

    /**
     * @description Customer testimonials. Publicly readable, admin writable.
     * @path /testimonials/{testimonialId}
     */
    match /testimonials/{testimonialId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }
  }
}
